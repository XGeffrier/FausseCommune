<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fausse Commune</title>

    <!-- Favicon (placeholder SVG) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫Ô∏è</text></svg>">

    <!-- Biblioth√®ques externes -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* ===== RESET ET BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== CONTENEUR PRINCIPAL ===== */
        .container {
            max-width: 1400px;
            width: 100%;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Hauteur dynamique : prend l'espace disponible sans d√©border */
            max-height: calc(100vh - 40px);
        }

        /* ===== HEADER (TITRE + BOUTON AIDE) ===== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0; /* Ne pas r√©tr√©cir le header */
        }

        .title {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        /* Container pour le texte + bouton d'aide */
        .help-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Texte "Comment jouer" */
        .help-text {
            font-size: 16px;
            font-weight: 500;
            color: white;
            white-space: nowrap;
        }


        /* Bouton d'aide (?) */
        .help-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .help-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* ===== WRAPPER DU JEU (CARTE + INDICES) ===== */
        .game-wrapper {
            display: flex;
            flex-direction: row;
            flex: 1; /* Prend tout l'espace restant */
            overflow: hidden; /* √âvite les d√©bordements */
        }

        /* ===== CONTENEUR DE LA CARTE ===== */
        .map-container {
            flex: 1;
            position: relative;
            min-height: 400px; /* Hauteur minimum */
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ===== CONTENEUR DES INDICES ET SCORE ===== */
        .hints-container {
            width: 350px;
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* √âvite les d√©bordements */
        }

        /* Section des indices (partie haute) */
        .hints-section {
            flex: 1; /* Prend l'espace disponible */
            padding: 30px;
            overflow-y: auto; /* Scroll si trop d'indices */
            display: flex;
            flex-direction: column;
        }

        .hints-header {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .hints-list {
            list-style: none;
            flex: 1;
        }

        .hint-item {
            background: white;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .hint-item:hover {
            transform: translateX(5px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 20px;
            color: #667eea;
        }

        /* ===== SECTION SCORE (PARTIE BASSE) ===== */
        .score-section {
            padding: 20px 30px;
            background: white;
            border-top: 2px solid #e0e0e0;
            flex-shrink: 0; /* Ne pas r√©tr√©cir */
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .score-label {
            font-size: 16px;
            color: #666;
            font-weight: 500;
        }

        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .best-score-value {
            color: #f39c12; /* Couleur dor√©e pour le meilleur score */
        }

        /* ===== OVERLAY DE VICTOIRE ===== */
        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .victory-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .victory-message {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        /* ===== MODALES (GAME OVER + AIDE) ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-title {
            font-size: 28px;
            font-weight: bold;
            color: #d9534f;
            margin-bottom: 20px;
        }

        .modal-title.help-title {
            color: #667eea;
        }

        .modal-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 20px;
            text-align: left;
        }

        .modal-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }

        .modal-button:hover {
            background: #5568d3;
        }

        .modal-button.secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .modal-button.secondary:hover {
            background: #5a6268;
        }

        /* ===== RESPONSIVE MOBILE ===== */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                max-height: calc(100vh - 20px);
            }

            .header {
                padding: 15px 20px;
            }

            .title {
                font-size: 24px;
            }

            /* Cache le texte "Comment jouer" sur mobile */
            .help-text {
                display: none;
            }

            .help-button {
                width: 35px;
                height: 35px;
                font-size: 20px;
            }

            /* Empilement vertical sur mobile */
            .game-wrapper {
                flex-direction: column;
            }

            .hints-container {
                width: 100%;
                border-left: none;
                border-top: 3px solid #667eea;
                max-height: 50vh; /* Limite la hauteur sur mobile */
            }

            .map-container {
                min-height: 300px;
            }

            .hints-section {
                padding: 20px;
            }

            .score-section {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- ===== HEADER AVEC TITRE ET BOUTON AIDE ===== -->
    <div class="header">
        <div class="title">üó∫Ô∏è Fausse Commune</div>
        <div class="help-wrapper">
            <span class="help-text">Comment jouer</span>
            <button class="help-button" onclick="showHelp()" aria-label="Aide">?</button>
        </div>
    </div>

    <!-- ===== JEU (CARTE + INDICES) ===== -->
    <div class="game-wrapper">
        <!-- CARTE -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- INDICES ET SCORE -->
        <div class="hints-container">
            <!-- Section indices (partie haute) -->
            <div class="hints-section">
                <div class="hints-header">De quelle r√©gion viennent ces communes ?</div>
                <ul class="hints-list" id="hints-list">
                    <li class="loading">Chargement...</li>
                </ul>
            </div>

            <!-- Section score (partie basse) -->
            <div class="score-section">
                <div class="score-item">
                    <span class="score-label">Score actuel :</span>
                    <span class="score-value" id="current-score">0</span>
                </div>
                <div class="score-item">
                    <span class="score-label">Meilleur score :</span>
                    <span class="score-value best-score-value" id="best-score">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ===== OVERLAY DE VICTOIRE ===== -->
<div class="victory-overlay" id="victory-overlay">
    <div class="victory-message" id="victory-message">
        Round 1 gagn√© ! üéâ
    </div>
</div>

<!-- ===== MODALE GAME OVER ===== -->
<div class="modal" id="game-over-modal">
    <div class="modal-content">
        <div class="modal-title">üò¢ Perdu !</div>
        <p class="modal-text">Nombre de rounds remport√©s : <strong><span id="final-round">0</span></strong></p>
        <button class="modal-button" onclick="restartGame()">Rejouer</button>
    </div>
</div>

<!-- ===== MODALE D'AIDE ===== -->
<div class="modal" id="help-modal">
    <div class="modal-content">
        <div class="modal-title help-title">üìñ Comment jouer ?</div>
        <div class="modal-text">
            <p><strong>[PLACEHOLDER - R√®gles du jeu]</strong></p>
            <p>Ici seront affich√©es les explications d√©taill√©es du jeu Fausse Commune.</p>
            <p>Vous pourrez expliquer comment utiliser les indices, cliquer sur les marqueurs, etc.</p>
        </div>
        <button class="modal-button" onclick="closeHelp()">Compris !</button>
    </div>
</div>

<script>
    /* ========================================
       VARIABLES GLOBALES
       ======================================== */
    let map; // Objet carte Leaflet
    let currentRound = 0; // Round actuel (commence √† 0)
    let gameSeed; // Seed de la partie actuelle
    let markers = []; // Tableau des marqueurs sur la carte
    let bestScore = 0; // Meilleur score du joueur

    /* ========================================
       GESTION DU MEILLEUR SCORE (LOCALSTORAGE)
       ======================================== */

    /**
     * Charge le meilleur score depuis le localStorage
     * Le localStorage permet de sauvegarder des donn√©es dans le navigateur
     */
    function loadBestScore() {
        const saved = localStorage.getItem('fausseCommune_bestScore');
        if (saved !== null) {
            bestScore = parseInt(saved, 10);
            document.getElementById('best-score').textContent = bestScore;
        }
    }

    /**
     * Sauvegarde le meilleur score dans le localStorage
     */
    function saveBestScore(score) {
        if (score > bestScore) {
            bestScore = score;
            localStorage.setItem('fausseCommune_bestScore', bestScore.toString());
            document.getElementById('best-score').textContent = bestScore;
        }
    }

    /**
     * Met √† jour l'affichage du score actuel
     */
    function updateCurrentScore(score) {
        document.getElementById('current-score').textContent = score;
    }

    /* ========================================
       INITIALISATION DE LA CARTE
       ======================================== */

    /**
     * Initialise la carte Leaflet centr√©e sur la France
     */
    function initMap() {
        // Cr√©e la carte dans l'√©l√©ment avec l'id "map"
        // setView([latitude, longitude], niveau_de_zoom)
        map = L.map('map').setView([46.603354, 1.888334], 6);

        // Ajoute les tuiles (images de la carte) depuis OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Force le recalcul des dimensions imm√©diatement et apr√®s un d√©lai
        // Le premier appel g√®re le cas o√π le CSS est d√©j√† charg√©
        // Le second g√®re le cas o√π le navigateur a besoin de plus de temps
        map.invalidateSize();
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
    }

    /* ========================================
       G√âN√âRATION DE LA SEED
       ======================================== */

    /**
     * G√©n√®re une seed bas√©e sur le timestamp actuel
     * Une nouvelle seed = une nouvelle partie
     */
    function generateSeed() {
        return Math.floor(Date.now() / 1000).toString();
    }

    /* ========================================
       CHARGEMENT D'UN ROUND
       ======================================== */
    /**
     * Effectue un appel de pr√©chauffage pour √©viter le cold start
     * Lance la requ√™te d√®s que possible sans attendre le r√©sultat
     */
    function warmupAPI() {
        // Appel de pr√©chauffage avec une seed temporaire
        fetch('/api/get_round', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                game_seed: 'warmup',
                round_ix: 0
            })
        }).catch(() => {
            // On ignore les erreurs du warmup, ce n'est pas grave
        });
    }

    /**
     * Charge les donn√©es d'un round depuis l'API Flask
     * @param {number} roundIx - Index du round √† charger (commence √† 0)
     */
    async function loadRound(roundIx) {
        try {
            // Envoie une requ√™te POST √† l'API Flask
            const response = await fetch('/api/get_round', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    game_seed: gameSeed,
                    round_ix: roundIx
                })
            });

            // V√©rifie que la requ√™te a r√©ussi
            if (!response.ok) {
                throw new Error('Erreur lors du chargement du round');
            }

            // Convertit la r√©ponse JSON en objet JavaScript
            const data = await response.json();

            // Affiche le round sur la carte
            displayRound(data, roundIx);
        } catch (error) {
            console.error('Erreur:', error);
            document.getElementById('hints-list').innerHTML =
                '<li class="hint-item">Erreur de chargement</li>';
        }
    }

    /* ========================================
       AFFICHAGE D'UN ROUND
       ======================================== */

    /**
     * Affiche les donn√©es d'un round sur la carte et dans l'interface
     * @param {Object} data - Donn√©es du round (good_coords, bad_coords, fake_names)
     * @param {number} roundIx - Index du round
     */
    function displayRound(data, roundIx) {
        // Nettoie tous les anciens marqueurs de la carte
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Met √† jour le score actuel
        currentRound = roundIx;
        updateCurrentScore(currentRound);

        /* ===== AFFICHAGE DES INDICES ===== */
        const hintsList = document.getElementById('hints-list');
        hintsList.innerHTML = ''; // Vide la liste

        // Cr√©e un √©l√©ment <li> pour chaque indice
        data.fake_names.forEach(hint => {
            const li = document.createElement('li');
            li.className = 'hint-item';
            li.textContent = hint;
            hintsList.appendChild(li);
        });
        map.invalidateSize()

        /* ===== CR√âATION DES MARQUEURS ===== */

        // Marqueur pour les BONNES coordonn√©es
        // Note : Leaflet utilise [latitude, longitude]
        const goodMarker = L.circleMarker([data.good_coords[0], data.good_coords[1]], {
            color: '#dc3545',
            fillColor: '#dc3545',
            fillOpacity: 0.8,
            radius: 12
        }).addTo(map);

        // Ajoute un √©v√©nement au clic sur le bon marqueur
        goodMarker.on('click', () => {
            handleCorrectAnswer();
        });

        markers.push(goodMarker);

        // Marqueurs pour les MAUVAISES coordonn√©es
        data.bad_coords.forEach(coords => {
            const badMarker = L.circleMarker([coords[0], coords[1]], {
                color: '#dc3545',
                fillColor: '#dc3545',
                fillOpacity: 0.8,
                radius: 12
            }).addTo(map);

            // Ajoute un √©v√©nement au clic sur le mauvais marqueur
            badMarker.on('click', () => {
                handleWrongAnswer();
            });

            markers.push(badMarker);
        });

        /* ===== AJUSTEMENT DE LA VUE ===== */
        // Zoom automatique pour que tous les marqueurs soient visibles
        const allCoords = [data.good_coords, ...data.bad_coords];
        const bounds = L.latLngBounds(allCoords.map(c => [c[0], c[1]]));
        map.fitBounds(bounds, {padding: [50, 50]});
    }

    /* ========================================
       GESTION DES R√âPONSES
       ======================================== */

    /**
     * Appel√©e quand le joueur clique sur la bonne r√©ponse
     */
    function handleCorrectAnswer() {
        // Affiche le message de victoire
        const overlay = document.getElementById('victory-overlay');
        const message = document.getElementById('victory-message');
        message.textContent = `Round ${currentRound + 1} gagn√© ! üéâ`;
        overlay.classList.add('show');

        // Lance l'animation de confettis
        confetti({
            particleCount: 100,
            spread: 70,
            origin: {y: 0.6},
            zIndex: 100000 // S'assure que les confettis sont au-dessus de tout
        });

        // Attend 2 secondes puis passe au round suivant
        setTimeout(() => {
            overlay.classList.remove('show');
            setTimeout(() => {
                loadRound(currentRound + 1);
            }, 500);
        }, 2000);
    }

    /**
     * Appel√©e quand le joueur clique sur une mauvaise r√©ponse
     */
    function handleWrongAnswer() {
        // Sauvegarde le meilleur score si n√©cessaire
        saveBestScore(currentRound);

        // Affiche la modale de game over
        document.getElementById('final-round').textContent = currentRound;
        document.getElementById('game-over-modal').classList.add('show');
    }

    /* ========================================
       CONTR√îLES DU JEU
       ======================================== */

    /**
     * Red√©marre une nouvelle partie
     */
    function restartGame() {
        document.getElementById('game-over-modal').classList.remove('show');
        gameSeed = generateSeed(); // Nouvelle seed = nouvelle partie
        currentRound = 0;
        updateCurrentScore(0);
        loadRound(0);
    }

    /**
     * Affiche la modale d'aide
     */
    function showHelp() {
        document.getElementById('help-modal').classList.add('show');
    }

    /**
     * Ferme la modale d'aide
     */
    function closeHelp() {
        document.getElementById('help-modal').classList.remove('show');
    }

    /* ========================================
       INITIALISATION AU CHARGEMENT
       ======================================== */

    /**
     * Fonction ex√©cut√©e quand la page est compl√®tement charg√©e
     */
    window.onload = () => {
        warmupAPI(); // Lance l'appel de pr√©chauffage imm√©diatement
        initMap(); // Initialise la carte
        loadBestScore(); // Charge le meilleur score
        gameSeed = generateSeed(); // G√©n√®re une seed
        loadRound(0); // Charge le premier round
    };

    /**
     * Ajuste la carte quand la fen√™tre change de taille
     */
    window.addEventListener('resize', () => {
        if (map) {
            map.invalidateSize();
        }
    });
</script>
</body>
</html>